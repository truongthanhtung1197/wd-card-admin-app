name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Get source
        uses: actions/checkout@v4

      - name: ğŸ”” Notify start deploy
        run: |
          export TZ='Asia/Ho_Chi_Minh'
          TIME=$(date +'%H:%M:%S %d-%m-%Y')
          ACTOR="${{ github.actor }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=MarkdownV2 \
          -d text="ğŸš€ *Starting Deploy CRM App*  ğŸ• Time: \`${TIME}\` ğŸ‘¤ Actor: \`${ACTOR}\`"

      - name: ğŸ“¦ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"

      - name: ğŸ“¥ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ› ï¸ Build
        run: yarn build

      - name: âŒ Notify build failed
        if: failure()
        run: |
          export TZ='Asia/Ho_Chi_Minh'
          TIME=$(date +'%H:%M:%S %d-%m-%Y')
          ACTOR="${{ github.actor }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=MarkdownV2 \
          -d text="âŒ *Build CRM App Failed*  ğŸ• \`${TIME}\` ğŸ‘¤ \`${ACTOR}\`"

      - name: ğŸšš Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 22.14.0
            node -v
            yarn -v
            cd /var/source_code/crm-app
            git checkout .
            git pull origin main
            rm -rf node_modules yarn.lock
            yarn install --frozen-lockfile
            yarn build
            if [ $? -eq 0 ]; then
              pm2 restart crm-app
            else
              echo "Build failed, skipping PM2 restart"
              exit 1
            fi

      - name: âœ… Notify deploy success
        run: |
          export TZ='Asia/Ho_Chi_Minh'
          TIME=$(date +'%H:%M:%S %d-%m-%Y')
          ACTOR="${{ github.actor }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=MarkdownV2 \
          -d text="âœ… *Deploy CRM App Successful* ğŸ‰ CRM App has been updated ğŸ• \`${TIME}\` ğŸ‘¤ \`${ACTOR}\`"

      - name: âŒ Notify deploy failed
        if: failure()
        run: |
          export TZ='Asia/Ho_Chi_Minh'
          TIME=$(date +'%H:%M:%S %d-%m-%Y')
          ACTOR="${{ github.actor }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=MarkdownV2 \
          -d text="ğŸš« *Deploy CRM App Failed* ğŸ• \`${TIME}\` ğŸ‘¤ \`${ACTOR}\`"
